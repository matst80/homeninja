<html>
    <head>
      <script src="/mqtt.js"></script>
      <style>
          body {
              display: flex;
          }
          .node {
            flex-basis: 150px;
            display: flex;
            margin:10px;
            padding:10px;
            background-color: #ccc;
          }
          div.off {
              background: #000;
              color:#fff;
          }
          #items {
              clear: both;
          }
      </style>
    </head>
    <body>
        <h1>Hoho</h1>
        <div id="items"></div>
        <textarea id="evts"></textarea>
      <script>
        var client = mqtt.connect();
        client.subscribe("#");
        //client.subscribe("homeninja/notify");
        var items = {};
        var evts = document.getElementById('evts');
        var itemParent = document.getElementById('items');

        function createOrUpdate(item) {
            var id = item.topic.replace('/','');
            var elm = document.getElementById(item.topic);
            
            if (!elm)
            {
                elm = document.createElement('div');
                
                elm.addEventListener('click',function() {
                    var state = this.classList.contains('off');
                    //console.log('click',item);
                    if (state) {
                        this.classList.remove('off');
                    }
                    else
                        this.classList.add('off');
                        client.publish(item.topic+"/set",state?"on":"off");
                    
                },true);
                elm.className = 'node off';
                elm.id = item.topic;
                elm.innerHTML = item.name;
                itemParent.appendChild(elm);
            }
        }

        function parseStates(s) {
            for(i in s) {
                var item = s[i];
                console.log(item);
                createOrUpdate(item);
            }
        }

        client.on("message", function(topic, payload) {
            if (topic=="homeninja/clientadded") {
                console.log('client added',payload);
                
                var obj = JSON.parse(payload);
                parseStates(obj.nodes);
                console.log(obj);
            }
            else if (topic=="homeninja/notify"){
                alert(payload);
            }
            else {
                evts.value+=([topic, payload].join(": "))+'\n';
            }
            
        });

        var serverNode = {
            features:['webgui','notification'],
            name:'this webserver',
            topic:'homeninja/serverweb'
        };
  
        client.publish("homeninja/init", JSON.stringify(serverNode));
      </script>
    </body>
  </html>